name: Security Invariant Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  invariant-tests:
    name: Run Security Invariant Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install package in editable mode
        run: |
          pip install -e .
      
      - name: Run invariant tests
        run: |
          pytest tests/test_invariants.py -v --tb=short
      
      - name: Verify ledger integrity (integration)
        run: |
          # Quick smoke test
          mkdir -p state
          python -m cli.main init-identities --out state --who test_owner
          python -m cli.main init-identities --out state --who test_grantee
          
          # Commit dataset
          echo "ACGTACGT" > /tmp/test.vcf
          python -m cli.main commit --dataset /tmp/test.vcf --out state --owner test_owner
          
          # Verify ledger
          python -m cli.main verify --out state
      
      - name: Check schema versioning
        run: |
          # Verify all payloads have schema field
          python -c "
          import json
          blocks = []
          with open('state/ledger.jsonl') as f:
              for line in f:
                  blocks.append(json.loads(line))
          
          for idx, block in enumerate(blocks):
              payload = block['payload']
              assert 'schema' in payload, f'Block {idx} missing schema field!'
              assert payload['schema'] == 'dna-ledger-vault/vNext.2', f'Block {idx} has wrong schema!'
          
          print(f'✅ All {len(blocks)} blocks have correct schema')
          "
  
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy
          pip install -r requirements.txt
      
      - name: Run ruff (linter)
        run: |
          ruff check . --select E,F,W,C90 --ignore E501
        continue-on-error: true
      
      - name: Run mypy (type checker)
        run: |
          mypy dna_ledger vault cli --ignore-missing-imports --no-strict-optional
        continue-on-error: true
  
  security-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run pip audit
        run: |
          pip install pip-audit
          pip-audit --requirement requirements.txt
        continue-on-error: true
  
  documentation:
    name: Documentation Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify SECURITY.md invariants
        run: |
          # Check all 8 invariants documented
          grep -q "1. Append-Only Ledger" docs/SECURITY.md
          grep -q "2. Full Block Header Hashing" docs/SECURITY.md
          grep -q "3. Domain-Separated Hashing" docs/SECURITY.md
          grep -q "4. Dataset Commit Binding" docs/SECURITY.md
          grep -q "5. Wrap State Enforcement" docs/SECURITY.md
          grep -q "6. Vault AAD Binding" docs/SECURITY.md
          grep -q "7. Signature Versioning" docs/SECURITY.md
          grep -q "8. Merkle Inclusion Proofs" docs/SECURITY.md
          echo "✅ All 8 invariants documented"
      
      - name: Verify AUDIT.md completeness
        run: |
          test -f docs/AUDIT.md
          grep -q "Threat Model Summary" docs/AUDIT.md
          grep -q "Security Invariants" docs/AUDIT.md
          grep -q "Verification Commands" docs/AUDIT.md
          grep -q "Evidence Bundle Instructions" docs/AUDIT.md
          echo "✅ AUDIT.md complete"
